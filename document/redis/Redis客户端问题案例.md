
## Redis客户端问题案例

### Redis主从内存使用不一致问题

- 主节点服务器现象:主节点Redis的内存增涨的非常快，基本用满了maxmemory,从节点的redis并没有这么高的内存使用量，两个节点的内存使用量不一致
- 客户端现象:客户端产生了OOM异常，Redis主节点内存超过了maxmemory，无法在写入数据了
- 原因分析
  - 确实有大量写，可能是复制有问题，查询了redis的主从复制相关信息，复制是正常的，主从数据也是移植的
  ```
  //主节点的dbsize
  master:6379>dbsize
  (integer)213476

  //从节点的dbsize
    slave:6379>dbsize
   (integer)213476
  ```
  - 排查是否是客户端缓冲区的问题，执行info clients信息发现client_longest_output_list超过了30万对象，然后通过client list命令找到omem不正常的连接，一般大部分客户端的omem为0，执行如下代码找到非omem的请求,可以看到cmd=monitor,客户端又在执行monitor命令
  ```
  redis-cli client list |grep -v "omem 0"
  ```   
- 解决方案
  - 在运维层面禁用monitor命令，使用热rename-command来对这个命令重置为一个随机字符
  - 限制redis的客户端输出队列的大小
  
### Redis请求超时

- 主节点现象:客户端出现大量超时，经过分析超时是周期性的出现。服务端没有任何的异常，仅仅有一些慢查询。
- 原因分析:
  - 网络分析：经过分析客户端和服务器网络是正常
  - Redis服务:分析redis统计日志，并无任何异常
  - 客户端：由于是周期性出现，就和对应的慢查询日志关联起来，发现有慢查询日志就会出现请求超时，找到了引起慢查询的命令为hlen,发现查询了150万的元素，这样会导致redis的阻塞。
- 解决方案
  - 监控慢查询，一旦超过设定的阈值，就发出告警
  - 深入理解redis，采用正常的姿势使用，切忌在高并发请求下使用会阻塞慢查询的命令
  