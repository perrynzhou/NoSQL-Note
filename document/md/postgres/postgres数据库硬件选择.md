### Postgres数据库硬件选择


| 作者 | 时间 |QQ技术交流群 |
| ------ | ------ |------ |
| perrynzhou@gmail.com |2020/12/01 |中国开源存储技术交流群(672152841) |

#### 合理选择硬件

- CPU的选择

  - 是优先选择核数多的还是优先选择性能优先的？一般这两者联系的很紧密,单个处理器核心的速度方面，interl处于领先地位，因为Intel处理器与系统RAM之间传输速度更快。

  - 确定数据库应用的负载类型或者等级,最好的方式就是通过类似于top工具对当前数据库服务器进行监测,如果每个CPU运行的进程很少，则速度更快的CPU方案会更加适合这类型的工作负载。这种方案往往适用于以批处理的方式运行大量的查询，比如当需要对大量的数据进行排序以生成报表。如果所有的CPU均处于活动状态，并且伴随着大量进程的并发运行，那么选择多核心CPU的方案，这种方案更加适合存在大量用户的应用程序，比如web应用

  - 在Postgres 9.6+版本以后增加了并行顺序扫描、并行连接、并行聚合功能，选择更多核心的CPU方案

  - 如果用户需要考虑数据库导入导出操作，那么更好的选择就是使用更快的CPU，COPY是postgres性能最好的数据导入工具，这个工具很容易受到CPU的性能限制，所以CPU性能经常变为此类操作的瓶颈。在某些平台，使用pg_dump工具导出一个数据库副本是另外一个受限于CPU的例子
- 内存
  - 给Postgres数据库分配多大内存，取决于数据库的一些常见操作所处理的数据量。在一般情况下加大内存会提供一定的性能，但是针对如下几个场景，加大内存未必能提高数据库性能
    - 如果处理的数据量相对于系统内存非常小，那么加大内存也不会提升性能，这个时候用户需要更快的处理器
    - 当数据库进行表扫描时候，但是这些表的数据量远远大于数据库可以分配的内存时，比如数据仓库系统，这个时候用户需要更加快速的硬盘而非增加内存
- 磁盘
  - 用户经常会遇到数据库服务器中的CPU达到的瓶颈，也很有可能是磁盘的瓶颈。一般会有SAS和SATA两种类型的磁盘，一般情况下类似规格下单个SAS磁盘速度比SATA磁盘要快很多，传输速度也更快。
  - Raid方案中奇偶校验是对数据进行校验的一种形式，及时有些信息丢失也可以进行重建。使用奇偶校验的Raid级别从空间角度是有效的，数据写入可以在驱动器发生故障时候，不丢失数据，但是奇偶校验的计算将明显影响数据应用程序性能。
    - raid0(磁盘条带化):即同时使用多个磁盘，将数据分散到每个磁盘进行并行读写，性能有很大提高，但是磁盘组中任意卷上发生故障将丢失所有的数据
    - raid1(镜像):相同数据的多份拷贝在多个磁盘上,这种方式有时候可以提升性能。在处理2个读操作时候,可以通过向每个驱动器发送一个读操作来完成。在并行读取两个磁盘驱动器时候，每秒的查找速度可以提升一倍。当一个驱动器发生故障，系统将继续使用另一个。
    - raid10:首先使用成对的磁盘,并且使用raid1对这些磁盘进行镜像，然后使用raid0对结果集进行条带。这样既提升了性能，也降低单个磁盘对系统的影响。raid10特别适合写入负载很重的应用，在这种情况下raid5和raid6方式奇偶校验计算开销会导致磁盘性能严重降低，这个是提升数据库性能首选的raid级别
    - raid5(奇偶校验条带):介于raid0和raid1之间这种方案，类似于raid0,分片数据存储在磁盘中，从而提升读取性能，但是冗余数据被添加到了校验盘，如果阵列中一块磁盘坏了，丢失的数据可以使用该奇偶校验信息从剩余磁盘中重新计算出来。raid5能够用最小的磁盘浪费解决磁盘失效问题。
    - raid6:类似于Raid5,但是利用了两块独立的奇偶校验功能，这个校验功能在每个驱动器上，使得raid6在即使2块盘失效情况下也可以恢复。raid5和raid6基本具有相同的优缺点。

