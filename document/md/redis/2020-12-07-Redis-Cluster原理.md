## Redis Cluster原理


| 作者 | 时间 |QQ技术交流群 |
| ------ | ------ |------ |
| perrynzhou@gmail.com |2020/12/02 |中国开源存储技术交流群(672152841) |

#### Redis Cluster介绍

- Redis Cluster是Redis官方提供集群方案，比如三个Redis组成的Redis Cluster集群，每个节点负责整个集群的一部分数据，每个节点负责的数据多少可能不一样。这样三个Redis节点相互连接组成一个对等的集群，他们之间通过二进制协议交互集群信息
- Redis Cluster将所有的数据分为16384个槽位，每个节点负责一部分槽位的数据，槽位信息存储在每个节点中。当客户端连接Redis Cluster时候,也会得到一份Redis Cluster的集群槽位对应信息，当客户端要查找某个key时候，可以直接定位到目标节点,效率比较高。客户端测的集群槽位对应信息会在会在客户端缓存，同时防止客户端缓存的槽位信息和服务器端槽位信息不一致，客户端会针对这种情况进行槽位信息校验调整


#### Redis集群中定位算法
- 当客户端请求一个key操作时候，Redis Cluster集群会对这个key进行crc16算法进行hash计算，然后哈希值对16384个槽位进行取模来定位这个key所在的redis节点。同时Redis Cluster提供在在key上嵌套tag标记，这样可以强制key所挂的槽位等于tag所在槽位
```
//定位算法的伪代码
char *key = = "name";
uint32_t node_id = crc16(key,strlen(key))%16384;
```


#### Redis Cluster是如何进行迁移？
- Redis Cluster中迁移的最小单位是槽,Redis 是一个接着一个槽位进行迁移。当一个槽位是正在迁移时候，这个状态在源节点是migrating状态，在目标节点是imprting状态，这也表示了这个槽位是从源节点迁移到目标节点。
- Redis中使用redis-trib工具先针对源节点和目标节点设置迁移过程中的状态，然后一次遍历源端需要迁移的所有key的列表，然后依次针对每个key做dump操作得到序列化内容，然后向目标节点发送restore指令然后携带以key序列化内容作为参数，目标节点接受到内容，然后反序列化内容恢复到目标节点中，然后返回操作的ACK，源节点收到ACK，最后在源节点删除这个key的信息。所以redis cluster迁移具有如下基本
```
1.设置源和目标端节点状态
2.获取源节点需要迁移所有key列表
3.源端按照列表进行dump，然后发送给目标节点
4.目标节点收到数据，反序列化内容然后恢复到目标节点，返回ack给源节点
5.源节点收到目标节点的ACK，删除这个key对应的信息
```
- 在迁移过程中出现了网络分区，整个集群的槽位迁移了一部分，这个时候源节点和目标节点都是出于中间状态，等网络分区恢复了，会提示继续迁移。迁移过程中尽量避免大key内容的迁移，因为migrate命令是阻塞式命令，如果迁移了大key的内容，会导致源节点和目标节点同时卡顿，会影响集群的稳定性。
- 迁移过程中的2个节点对应的槽位都存在部分key数据，客户端请求来时候，优先请求源节点，如果对应数据存在于源节点，就在源节点处理；如果对应数据在源节点不存在，则有2种情况，第一是数据在目标节点中，要么不存在。由于源节点分不清具体是那种情况，则让客户端把请求重定向到目标节点。

#### Redis Cluster高可用
- Redis Cluster可以为每个主节点设置若干个从节点,当主节点发生故障时候,集群会自动将其中某个从节点提升为主节点。但是这里有一个很大的风险，如果某个主节点没有从节点，那么当它发生故障时候，集群完全处于不可用状态。redis也提供了一个参数cluster-require-full-coverage可以允许部分节点发生故障，其他节点可以继续对外提供服务。

- Redis Cluster是去中心化的，如果一个节点失联并不代表所有的节点都认为它失联了，所有集群需要进行一次协商，只有当当大多数节点都人为这个节点失联，集群才认定这个节点需要进行主从切换。集群中的节点有2个失联状态，一个是PFail；另外一个是Fail.集群采用了gossip协议来广播自己的状态以及改变对整个集群的认知，例如一个节点发现某个节点失联(pfail),它将会把这个信息向整个集群广播,其他节点就可以收到这个节点的失联信息。如果收到这个节点pfail消息的节点数超过一半,那集群就标记这个节点为fail状态，然后向整个集群广播，强迫其他节点也接受这个节点fail的现实，并立即对这个fail节点进行主从切换。

- 为了防止偶然的网络抖动,Redis Cluster提供了cluster-node-timeout的参数，比如cluster-node-timeout配置为15000，表示某个节点持续15秒的时间失联时候，才可以认定该节点出现故障，集群需要针对该节点进行主从切换。redis同时还提供cluster-slave-validity-factor参数作为放大超时时间系数，如果这个系数为0，那么一旦出现网络抖动都会进行主从切换，如果这个系数大于1，它就可以防止一定的由于网络抖动而造成节点的频繁的主从切换

