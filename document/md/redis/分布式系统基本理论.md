
## 分布式系统基本理论

| 作者 | 时间 |QQ技术交流群 |
| ------ | ------ |------ |
| perrynzhou@gmail.com |2020/11/25 |中国开源存储技术交流群(672152841) |

- 分布式系统中涉及到的基本概念
    - 进程和线程：进程是操作系统资源分配和调度的基本单位，线程是进程的一个实体，是CPU调度和时间片分配的基本单位，线程是比进程更小的独立运行的基本单位
    - 并发和并行：单CPU情况，多线程执行，根本不可能同时进行一个以上的线程执行，它只能把CPU运行时间切分为若干时间段，通过操作系统的再把各个时间段分配给各个线程，一个时间段运行线程代码，其他的线程处于挂起阶段，这项的方式成为并发。并行，多个进程或者线程同时运行，每个进程或者线程独立占用CPU的所有时间段。
    - 锁：锁是用来保临界资源的一种机制，减少或者规避锁争用一般如下几种策略：
      - 分拆锁：尽量避免是使用全局锁。把临界资源划分为多个，每个锁守护不同的临界资源
      - 分离锁：分拆锁有时候被扩展，分成若干锁块的集合，并且并且他们归属于相互独立的对象，这种情况成为分离锁
    - 集群：集群是一组相互独立、通过高速网络互连的计算机，它们构成了一组，并以单一系统的模式加以管理，一般分布式系统有如下几类的服务
      - 节点:系统中按照协议完成计算工作的逻辑实体或者物理实体,一般是进程或者机器
      - 网络:系统的数据传输的通道，用来彼此统计更新，通信是具有方向性的，一般是全双工的方式
      - 存储：系统中用于存储数据
    - 分布式系统中的状态
      - 无状态:应用中大致为分有状态和无状态服务,无状态服务是指仅仅涉及到计算，并无任何数据存储的功能，这种的应用扩展性非常好，比如负载很高就直接在扩展同样这样的服务；
      - 有状态：这类应用是有计算和持久化功能，比如mysql/postgresql/redis等，当负载高的情况下，扩展一个节点必须要同步服务的所有的数据，同时需要考虑这些节点的数据一致性。
    - 幂等性:幂等性，是调用1次或者N次要返回一样的结果
  - 硬件异常：一般包括服务器宕机、网络异常、磁盘故障、机房级异常等，每种情况有一定的解决方案，针对服务器宕机，有状态服务采用M/S；无状态服务采用部署多份到多个服务器。网络异常，如果是运营商的问题，最好采用双线路；磁盘故障，尽量采用数据写多份；机房级异常，采用三地两中心的部署方式，异地双活。

- 分布式理论基本
  - CAP理论:一般CAP这三种因素不可能同时满足,一般都满足其中两种的组合
    - 一致性(C)：分布式系统中所有数据，在同一时刻是否具有一样的值。一般分为强一致性、弱一致性、最终一致性等。一致性被称为原子对象，任何读写看起来都是原子操作或者串行的读写。
    - 可用性(A)：在集群中某一个节点出故障，集群整体客户是否还能响应客户端的读写请求，任何非失败节点应该在有限时间内给出请求的回应
    - 分区容忍性(P):在一个集群中，一部分节点和另外一部分节点网络无法通信，这时候整个集群是否能否对外提供服务。允许节点之间丢失任意多消息，当网络分区发生时候，节点之间的消息可能会全完丢失
  - 常用的分布式算法
    - Poxos:该协议是基于消息传递的一致性算法，它解决了分布式系统中多个节点之间就某个值达成一致性的通信协议，能欧处理在少数节点离线的情况下，剩余的多数节点仍然能够达成一致。该算法分为2个阶段，Prepare阶段和Accept阶段，该一些涉及2个参与者角色，一个是Proposer和Acceptor，Proposer是提议案者扥服务器，Acceptor是批准议案德玛服务器。
    - 2PC：两阶段提交协议是一种典型的原子提交协议，是一种由协调器来处理分布式原子参与者是提交或者回滚事务的算法，该协议包括2个阶段，第一个阶段是提交请求，第二个阶段是提交阶段。2PC协议最大的缺点是它是阻塞协议，如果协调者出问题会导致某些参与者将无法解决他们的事务
    - 3PC：三阶段提交，分为三次交互，第一次投票，第二年阶段是预提交，第三阶段是提交阶段
    - Raft:该协议和Poxos类似，是一致性算法
    - Lease:该机制是授权者授予分布式环境一段时间内的承诺，比如缓存服务器，客户端节点A,B,C，其中A、B节点得到数据V1,V1数据有效期在12点，C节点得到数据V2，V2数据有效期在12点15.在Lease时间范围内，服务端遵守租约，在lease租约时间内不再修改数据。V1和V2如果租约时间到了，服务端则要删除数据
  - 脑列问题
      - 脑列:是指在一个HA系统中，当联系的两个节点断开联系时候，原来整个集群分裂为2个集群，两个集群开始争抢资源，导致数据损坏。
      - 解决方案：引入第三方检测服务(mintor service),当slave准备接管master时候，monitor ping下master,如果无法通信，则认为master死忙；同时master也每个一段时间间隔ping下slave和monitor，一旦无法通信，则不对外提供服务。
    - MVCC
      - 多版本控制，这是一种乐观锁，读写互相不阻塞。
      - mysql innodb如何实现innodb多版本的？
        - 引擎为每个表实现都添加2个字段，一个是create version和delete version
        - 插入操作时候，create version就是事务的版本号
        - 更新操作时候，采用标记记录旧的那一行记录为已删除，并且delete version就是事务版本号，然后插入一行新记录的方式
        - 删除操作时候，就把事务版本号作为delete version
        - 只有当当前事务>delete version或者create version<当前事务号数据才会查询出来
  
- 分布式系统设计的策略
  - 如何检测节点还活着?
    - 周期检测心跳机制/累计失效检测机制可以判断集群中的节点是否"死亡"，如果判断死亡则从集群中踢出去
  - 如何保障高可用?
    - 高可用一般菜肴采用master/slave、multi-master互备模式。m/s方式在mysql复制中实现，master提供写服务，slave提供度服务，master和slave之间存在一定的延迟。
    - multi-master模式，两个master互相检测，每个master都提供写操作，可以根据业务的时间戳或者业务逻辑标识，两个master按照标识把互相确实的数据通过某种方式进行同步，达到数据的最终一致。
  - 容错处理?
    - 容错处理是保障分布式环境下系统高可用或者健壮性，一个典型的案例就是缓存失效和雪崩问题的解决方案。通用解决缓存失效，可以在缓存中的数据可以采用bloom-filter(hash+bitmap)来标识数据是否存在于缓存中，来防止缓存雪崩的问题，这种方案存在一定的误差。
  - 重试机制?
    - 针对请求失败的情况，需要设计一个超时时间和尝试次数，一旦超过这些设置的阈值就认为此次请求失败
  - 负载均衡
    - 负载均衡关键在于使用多台集群服务器共同分担计算任务，把网络请求的流量平均分摊到每个节点，从而方式单个节点负载非常高的情况，，常用的负载均衡解决方案有，硬件F5，软件有LVS,HAProxy,Nginx等。其中nginx的负载均衡有轮询、最少连接、IP地址哈希、基于权重的轮询

- 分布式系统设计实践
  - 全局ID生成